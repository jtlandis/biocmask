<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Data masks for SummarizedExperiment enabling dplyr-like manipulation • biocmask</title>
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Data masks for SummarizedExperiment enabling dplyr-like manipulation">
<meta name="description" content="The package provides `rlang` data masks for the SummarizedExperiment class. The enables the evaluation of unquoted expression in different contexts of the SummarizedExperiment object with optional access to other contexts. The goal for `biocmask` is for evaluation to feel like a data.frame object without ever needing to unwind to a rectangular data.frame.">
<meta property="og:description" content="The package provides `rlang` data masks for the SummarizedExperiment class. The enables the evaluation of unquoted expression in different contexts of the SummarizedExperiment object with optional access to other contexts. The goal for `biocmask` is for evaluation to feel like a data.frame object without ever needing to unwind to a rectangular data.frame.">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">biocmask</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.99.8</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="articles/biocmask.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/jtlandis/biocmask/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9"><div class="section level1">
<div class="page-header"><h1 id="readme">README<a class="anchor" aria-label="anchor" href="#readme"></a>
</h1></div>
<p>The goal of this repo is to design efficient abstractions to the <code>SummarizedExperiment</code> class such that using common dplyr functions feels as natural to operating on a <code>data.frame</code> or <code>tibble</code>. While the overall goal is for it to <strong>feel</strong> like a tibble operation, it would be smart to emphasize that certain data wrangling pipelines do not translate well to the structure of the <code>SummarizedExperiment</code> class.</p>
<p><strong><em>Note:</em></strong> This repository is still under active development. Internal structure of classes and code organization is likely to change.</p>
<div class="section level2">
<h2 id="example-data">Example Data<a class="anchor" aria-label="anchor" href="#example-data"></a>
</h2>
<p>I will be using the following example data throughout this document:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">se_example</span> <span class="op">&lt;-</span> <span class="fu">tidySummarizedExperiment</span><span class="fu">::</span><span class="va">pasilla</span></span>
<span><span class="co">#</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">tidySummarizedExperiment</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>Warning<span class="sc">:</span> package <span class="st">'S4Vectors'</span> was built under R version <span class="dv">4</span>.<span class="fl">4.1</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>Warning<span class="sc">:</span> package <span class="st">'IRanges'</span> was built under R version <span class="dv">4</span>.<span class="fl">4.1</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># load biocmask last to use its `dplyr` verbs</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jtlandis/biocmask" class="external-link">biocmask</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span></span>
<span><span class="va">se</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/RangedSummarizedExperiment-class.html" class="external-link">SummarizedExperiment</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>counts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">20</span>, <span class="fl">20</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">5</span>, ncol <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  rowData <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>gene <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"g%i"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span>,</span>
<span>                       length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">100</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                       direction <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"-"</span>,<span class="st">"+"</span><span class="op">)</span>, <span class="fl">5</span>, <span class="cn">T</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  colData <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>sample <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"s%i"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span>,</span>
<span>                       condition <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cntrl"</span>,<span class="st">"drug"</span><span class="op">)</span>, each <span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">se</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"row_%s"</span>, <span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">se</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"col_%s"</span>, <span class="va">LETTERS</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">assay</a></span><span class="op">(</span><span class="va">se</span>, <span class="st">'logcounts'</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">assay</a></span><span class="op">(</span><span class="va">se</span>, <span class="st">'counts'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">se</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="co"># A SummarizedExperiment-tibble Abstraction: 5 × 4</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>    .features .samples <span class="sc">|</span> counts logcounts <span class="sc">|</span> gene  length direction <span class="sc">|</span> sample</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>    <span class="sc">&lt;</span>chr<span class="sc">&gt;</span>     <span class="er">&lt;</span>chr<span class="sc">&gt;</span>    <span class="er">|</span>  <span class="er">&lt;</span>int<span class="sc">&gt;</span>     <span class="er">&lt;</span>dbl<span class="sc">&gt;</span> <span class="er">|</span> <span class="er">&lt;</span>chr<span class="sc">&gt;</span>  <span class="er">&lt;</span>int<span class="sc">&gt;</span> <span class="er">&lt;</span>chr<span class="sc">&gt;</span>     <span class="er">|</span> <span class="er">&lt;</span>chr<span class="sc">&gt;</span> </span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>  <span class="dv">1</span> row_a     col_A    <span class="sc">|</span>     <span class="dv">16</span>      <span class="fl">2.77</span> <span class="sc">|</span> g1         <span class="dv">3</span> <span class="sc">-</span>         <span class="er">|</span> s1    </span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>  <span class="dv">2</span> row_b     col_A    <span class="sc">|</span>      <span class="dv">5</span>      <span class="fl">1.61</span> <span class="sc">|</span> g2        <span class="dv">51</span> <span class="sc">-</span>         <span class="er">|</span> s1    </span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>  <span class="dv">3</span> row_c     col_A    <span class="sc">|</span>     <span class="dv">12</span>      <span class="fl">2.48</span> <span class="sc">|</span> g3        <span class="dv">24</span> <span class="sc">-</span>         <span class="er">|</span> s1    </span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>  <span class="dv">4</span> row_d     col_A    <span class="sc">|</span>     <span class="dv">15</span>      <span class="fl">2.71</span> <span class="sc">|</span> g4        <span class="dv">32</span> <span class="sc">+</span>         <span class="er">|</span> s1    </span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>  <span class="dv">5</span> row_e     col_A    <span class="sc">|</span>      <span class="dv">9</span>      <span class="fl">2.20</span> <span class="sc">|</span> g5        <span class="dv">49</span> <span class="sc">+</span>         <span class="er">|</span> s1    </span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>  …   …         …             …        …     …         … …            …    </span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a>n<span class="dv">-4</span> row_a     col_D    <span class="sc">|</span>      <span class="dv">8</span>      <span class="fl">2.08</span> <span class="sc">|</span> g1         <span class="dv">3</span> <span class="sc">-</span>         <span class="er">|</span> s4    </span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a>n<span class="dv">-3</span> row_b     col_D    <span class="sc">|</span>     <span class="dv">17</span>      <span class="fl">2.83</span> <span class="sc">|</span> g2        <span class="dv">51</span> <span class="sc">-</span>         <span class="er">|</span> s4    </span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a>n<span class="dv">-2</span> row_c     col_D    <span class="sc">|</span>      <span class="dv">1</span>      <span class="dv">0</span>    <span class="sc">|</span> g3        <span class="dv">24</span> <span class="sc">-</span>         <span class="er">|</span> s4    </span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a>n<span class="dv">-1</span> row_d     col_D    <span class="sc">|</span>     <span class="dv">18</span>      <span class="fl">2.89</span> <span class="sc">|</span> g4        <span class="dv">32</span> <span class="sc">+</span>         <span class="er">|</span> s4    </span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a>n   row_e     col_D    <span class="sc">|</span>      <span class="dv">3</span>      <span class="fl">1.10</span> <span class="sc">|</span> g5        <span class="dv">49</span> <span class="sc">+</span>         <span class="er">|</span> s4    </span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a><span class="co"># ℹ n = 20</span></span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a><span class="co"># ℹ 1 more variable: condition &lt;chr&gt;</span></span></code></pre></div>
<p>Below shows the profiling of performing a simple operation on a dataset with the following dimensional (14599 x 7).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">native_example</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">se</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">assay</a></span><span class="op">(</span><span class="va">se</span>, <span class="st">"logcounts"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log1p</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">assay</a></span><span class="op">(</span><span class="va">se</span>, <span class="st">"counts"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">se</span></span>
<span><span class="op">}</span></span>
<span><span class="va">new_example</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">se</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">biocmask</span><span class="fu">:::</span><span class="fu"><a href="reference/mutate.SummarizedExperiment.html">mutate.SummarizedExperiment</a></span><span class="op">(</span></span>
<span>    <span class="va">se</span>,</span>
<span>    logcounts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log1p</a></span><span class="op">(</span><span class="va">counts</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">old_example</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">se</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">tidySummarizedExperiment</span><span class="fu">:::</span><span class="fu">mutate.SummarizedExperiment</span><span class="op">(</span></span>
<span>    <span class="va">se</span>,</span>
<span>    logcounts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log1p</a></span><span class="op">(</span><span class="va">counts</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># underlying data is a data.frame and not a matrix</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">assay</a></span><span class="op">(</span><span class="va">se_example</span>, <span class="st">"counts"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">assay</a></span><span class="op">(</span><span class="va">se_example</span>, <span class="st">"counts"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu">bench</span><span class="fu">::</span><span class="fu">mark</span><span class="op">(</span></span>
<span>  native <span class="op">=</span> <span class="fu">native_example</span><span class="op">(</span><span class="va">se_example</span><span class="op">)</span>,</span>
<span>  new <span class="op">=</span> <span class="fu">new_example</span><span class="op">(</span><span class="va">se_example</span><span class="op">)</span>,</span>
<span>  old <span class="op">=</span> <span class="fu">old_example</span><span class="op">(</span><span class="va">se_example</span><span class="op">)</span>,</span>
<span>  check <span class="op">=</span> <span class="cn">F</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>Warning<span class="sc">:</span> Some expressions had a GC <span class="cf">in</span> every iteration; so filtering is</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>disabled.</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a><span class="co"># A tibble: 3 × 6</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>  expression      min   median <span class="st">`</span><span class="at">itr/sec</span><span class="st">`</span> mem_alloc <span class="st">`</span><span class="at">gc/sec</span><span class="st">`</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>  <span class="sc">&lt;</span>bch<span class="sc">:</span>expr<span class="sc">&gt;</span> <span class="er">&lt;</span>bch<span class="sc">:</span>tm<span class="sc">&gt;</span> <span class="er">&lt;</span>bch<span class="sc">:</span>tm<span class="sc">&gt;</span>     <span class="er">&lt;</span>dbl<span class="sc">&gt;</span> <span class="er">&lt;</span>bch<span class="sc">:</span>byt<span class="sc">&gt;</span>    <span class="er">&lt;</span>dbl<span class="sc">&gt;</span></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a><span class="dv">1</span> native       <span class="fl">14.1</span>ms     <span class="dv">18</span>ms     <span class="fl">54.9</span>   <span class="fl">804.77</span>KB     <span class="fl">1.96</span></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a><span class="dv">2</span> new          <span class="fl">23.6</span>ms   <span class="fl">25.2</span>ms     <span class="fl">38.8</span>     <span class="fl">9.42</span>MB     <span class="fl">3.88</span></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a><span class="dv">3</span> old         <span class="fl">893.7</span>ms  <span class="fl">893.7</span>ms      <span class="fl">1.12</span>   <span class="fl">83.53</span>MB     <span class="fl">3.36</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="the-abstraction">The abstraction<a class="anchor" aria-label="anchor" href="#the-abstraction"></a>
</h2>
<p>In order to access parts of the <code>SummarizedExperiment</code> as if it were a tibble, I propose we use some data masking concepts from the <code>rlang</code> package.</p>
<div class="section level3">
<h3 id="data-mask">data mask<a class="anchor" aria-label="anchor" href="#data-mask"></a>
</h3>
<p>To quote the documentation of <code><a href="https://rlang.r-lib.org/reference/as_data_mask.html" class="external-link">?rlang::new_data_mask</a></code>:</p>
<blockquote>
<p>A data mask is an environment (or possibly multiple environments forming an ancestry) containing user-supplied objects. Objects in the mask have precedence over objects in the environment (i.e. they mask those objects). Many R functions evaluate quoted expressions in a data mask so these expressions can refer to objects within the user data.</p>
</blockquote>
<p>In <a href="#sec-proposal" class="quarto-xref">Section 1.2.2</a> below, I will be constructing several environments to mask the structure of the <code>SummarizedExperiment</code> object.</p>
<p>We will be using the <code>!!</code> operator from the <code>rlang</code> package as well. For more information on what this does, please see <code><a href="https://rlang.r-lib.org/reference/injection-operator.html" class="external-link">?rlang::`bang-bang`</a></code></p>
</div>
<div class="section level3">
<h3 id="the-proposal">The proposal<a class="anchor" aria-label="anchor" href="#the-proposal"></a>
</h3>
<p><img src="_devel/data-mask-abstraction.png"></p>
<p>In <a href="#fig-abstraction" class="quarto-xref">Figure 1</a>, we an abstract a <code>SummarizedExperiment</code> object (top portion) into three distinct data masks (the bottom portion) that represent different evaluation contexts for our object. We are either evaluating on the <code>assay_mask</code>, <code>rowData_mask</code>, or the <code>colData_mask</code>.</p>
<div class="section level4">
<h4 id="top-level-of-the-mask">Top level of the mask<a class="anchor" aria-label="anchor" href="#top-level-of-the-mask"></a>
</h4>
<p>Data will be lazily bound to the top level of each mask “as is” from the <code>SummarizedExperiment</code> object’s data context.</p>
<p>For example, the <code>se</code> bindings in the top level may look like this:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rlang.r-lib.org" class="external-link">rlang</a></span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>Attaching package<span class="sc">:</span> <span class="st">'rlang'</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>The following object is masked from <span class="st">'package:Biobase'</span><span class="sc">:</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>    exprs</span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">shared_env</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/env.html" class="external-link">new_environment</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    .nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">se</span><span class="op">)</span>,</span>
<span>    .ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">se</span><span class="op">)</span></span>
<span>  <span class="op">)</span>, </span>
<span>  parent <span class="op">=</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/empty_env.html" class="external-link">empty_env</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># assay mask</span></span>
<span><span class="va">assay_mask_top</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">new.env</a></span><span class="op">(</span>parent <span class="op">=</span> <span class="va">shared_env</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rlang.r-lib.org/reference/env_bind.html" class="external-link">env_bind_lazy</a></span><span class="op">(</span></span>
<span>  <span class="va">assay_mask_top</span>, <span class="co"># The top environement</span></span>
<span>  counts <span class="op">=</span> <span class="op">!</span><span class="op">!</span><span class="fu"><a href="https://rlang.r-lib.org/reference/defusing-advanced.html" class="external-link">quo</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">assay</a></span><span class="op">(</span><span class="va">se</span>, <span class="st">"counts"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  logcounts <span class="op">=</span> <span class="op">!</span><span class="op">!</span><span class="fu"><a href="https://rlang.r-lib.org/reference/defusing-advanced.html" class="external-link">quo</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">assay</a></span><span class="op">(</span><span class="va">se</span>, <span class="st">"logcounts"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># rowData mask</span></span>
<span><span class="va">rowData_mask_top</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">new.env</a></span><span class="op">(</span>parent <span class="op">=</span> <span class="va">shared_env</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rlang.r-lib.org/reference/env_bind.html" class="external-link">env_bind_lazy</a></span><span class="op">(</span></span>
<span>  <span class="va">rowData_mask_top</span>, <span class="co"># the top environment</span></span>
<span>  gene <span class="op">=</span> <span class="op">!</span><span class="op">!</span><span class="fu"><a href="https://rlang.r-lib.org/reference/defusing-advanced.html" class="external-link">quo</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">rowData</a></span><span class="op">(</span><span class="va">se</span><span class="op">)</span><span class="op">[[</span><span class="st">"gene"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  length <span class="op">=</span> <span class="op">!</span><span class="op">!</span><span class="fu"><a href="https://rlang.r-lib.org/reference/defusing-advanced.html" class="external-link">quo</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">rowData</a></span><span class="op">(</span><span class="va">se</span><span class="op">)</span><span class="op">[[</span><span class="st">"length"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  direction <span class="op">=</span> <span class="op">!</span><span class="op">!</span><span class="fu"><a href="https://rlang.r-lib.org/reference/defusing-advanced.html" class="external-link">quo</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">rowData</a></span><span class="op">(</span><span class="va">se</span><span class="op">)</span><span class="op">[[</span><span class="st">"direction"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># colData mask</span></span>
<span><span class="va">colData_mask_top</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">new.env</a></span><span class="op">(</span>parent <span class="op">=</span> <span class="va">shared_env</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rlang.r-lib.org/reference/env_bind.html" class="external-link">env_bind_lazy</a></span><span class="op">(</span></span>
<span>  <span class="va">colData_mask_top</span>, <span class="co"># the top environemnt</span></span>
<span>  sample <span class="op">=</span> <span class="op">!</span><span class="op">!</span><span class="fu"><a href="https://rlang.r-lib.org/reference/defusing-advanced.html" class="external-link">quo</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">se</span><span class="op">)</span><span class="op">[[</span><span class="st">"sample"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  condition <span class="op">=</span> <span class="op">!</span><span class="op">!</span><span class="fu"><a href="https://rlang.r-lib.org/reference/defusing-advanced.html" class="external-link">quo</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">se</span><span class="op">)</span><span class="op">[[</span><span class="st">"condition"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Furthermore, each of these top level environments will have access to each other via a <strong>pronoun</strong> created by <code><a href="https://rlang.r-lib.org/reference/as_data_mask.html" class="external-link">rlang::as_data_pronoun</a></code>.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># assay mask access to rowData and colData</span></span>
<span><span class="fu"><a href="https://rlang.r-lib.org/reference/env_bind.html" class="external-link">env_bind</a></span><span class="op">(</span></span>
<span>  <span class="va">assay_mask_top</span>,</span>
<span>  .rows <span class="op">=</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/as_data_mask.html" class="external-link">as_data_pronoun</a></span><span class="op">(</span><span class="va">rowData_mask_top</span><span class="op">)</span>,</span>
<span>  .cols <span class="op">=</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/as_data_mask.html" class="external-link">as_data_pronoun</a></span><span class="op">(</span><span class="va">colData_mask_top</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># rowData mask access to assays and colData</span></span>
<span><span class="fu"><a href="https://rlang.r-lib.org/reference/env_bind.html" class="external-link">env_bind</a></span><span class="op">(</span></span>
<span>  <span class="va">rowData_mask_top</span>,</span>
<span>  .assay <span class="op">=</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/as_data_mask.html" class="external-link">as_data_pronoun</a></span><span class="op">(</span><span class="va">assay_mask_top</span><span class="op">)</span>,</span>
<span>  .cols <span class="op">=</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/as_data_mask.html" class="external-link">as_data_pronoun</a></span><span class="op">(</span><span class="va">colData_mask_top</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># colData mask access to assays and rowData</span></span>
<span><span class="fu"><a href="https://rlang.r-lib.org/reference/env_bind.html" class="external-link">env_bind</a></span><span class="op">(</span></span>
<span>  <span class="va">colData_mask_top</span>,</span>
<span>  .assay <span class="op">=</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/as_data_mask.html" class="external-link">as_data_pronoun</a></span><span class="op">(</span><span class="va">assay_mask_top</span><span class="op">)</span>,</span>
<span>  .rows <span class="op">=</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/as_data_mask.html" class="external-link">as_data_pronoun</a></span><span class="op">(</span><span class="va">rowData_mask_top</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This will allow users to access specific parts of the <code>SummarizedExperiment</code> object’s data “as is” before any modifications (as seen in later sections). For example, a user may evaluate <code>.rows$length</code> which forces the expression <code>rowData(se)[["length"]]</code>.</p>
</div>
<div class="section level4">
<h4 id="middle-level-of-the-mask">Middle level of the mask<a class="anchor" aria-label="anchor" href="#middle-level-of-the-mask"></a>
</h4>
<p>Here, we will lazily bind expressions that will mold the data to an expected length as if the user were working with a vector from a tibble. We will also be binding symbols for the other two environments, such that all parts of <code>se</code> are available regardless of which mask we are evaluating in.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># define some helper function</span></span>
<span><span class="va">quo_helper</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">env</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/force.html" class="external-link">force</a></span><span class="op">(</span><span class="va">env</span><span class="op">)</span></span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">expr</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">expr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/defusing-advanced.html" class="external-link">enexpr</a></span><span class="op">(</span><span class="va">expr</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rlang.r-lib.org/reference/new_quosure.html" class="external-link">new_quosure</a></span><span class="op">(</span><span class="va">expr</span>, env <span class="op">=</span> <span class="va">env</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="section level5">
<h5 id="assay-mask-moldings">assay mask moldings<a class="anchor" aria-label="anchor" href="#assay-mask-moldings"></a>
</h5>
<p>The expected output for the assay context would be as if the user unwrapped the <code>se</code> object into a full tibble. Thus each vector should be length <code>.nrow * .ncol</code> or equal to 20 in this example.</p>
<p>Here is an example of making all values from <code>se</code> available in the assay mask.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">assay_mask_mid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">new.env</a></span><span class="op">(</span>parent <span class="op">=</span> <span class="va">assay_mask_top</span><span class="op">)</span></span>
<span><span class="va">quo_assay</span> <span class="op">&lt;-</span> <span class="fu">quo_helper</span><span class="op">(</span><span class="va">assay_mask_top</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rlang.r-lib.org/reference/env_bind.html" class="external-link">env_bind_lazy</a></span><span class="op">(</span></span>
<span>  <span class="va">assay_mask_mid</span>,</span>
<span>  <span class="co">## bindings for assays...</span></span>
<span>  <span class="co">## - each element of assays(se) is a matrix</span></span>
<span>  <span class="co">##   thus we can cast to vector like so:</span></span>
<span>  counts <span class="op">=</span> <span class="op">!</span><span class="op">!</span><span class="fu">quo_assay</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">counts</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  logcounts <span class="op">=</span> <span class="op">!</span><span class="op">!</span><span class="fu">quo_assay</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">logcounts</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="co">## bindings for rowData...</span></span>
<span>  <span class="co">## - each vector here is length==.nrow and</span></span>
<span>  <span class="co">##   we must replicate .ncol </span></span>
<span>  gene <span class="op">=</span> <span class="op">!</span><span class="op">!</span><span class="fu">quo_assay</span><span class="op">(</span><span class="fu">vctrs</span><span class="fu">::</span><span class="fu"><a href="https://vctrs.r-lib.org/reference/vec-rep.html" class="external-link">vec_rep</a></span><span class="op">(</span><span class="va">.rows</span><span class="op">$</span><span class="va">gene</span>, times <span class="op">=</span> <span class="va">.ncol</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  length <span class="op">=</span> <span class="op">!</span><span class="op">!</span><span class="fu">quo_assay</span><span class="op">(</span><span class="fu">vctrs</span><span class="fu">::</span><span class="fu"><a href="https://vctrs.r-lib.org/reference/vec-rep.html" class="external-link">vec_rep</a></span><span class="op">(</span><span class="va">.rows</span><span class="op">$</span><span class="va">length</span>, times <span class="op">=</span> <span class="va">.ncol</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  direction <span class="op">=</span> <span class="op">!</span><span class="op">!</span><span class="fu">quo_assay</span><span class="op">(</span><span class="fu">vctrs</span><span class="fu">::</span><span class="fu"><a href="https://vctrs.r-lib.org/reference/vec-rep.html" class="external-link">vec_rep</a></span><span class="op">(</span><span class="va">.rows</span><span class="op">$</span><span class="va">direction</span>, times <span class="op">=</span> <span class="va">.ncol</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="co">## bindings for colData...</span></span>
<span>  <span class="co">## - each vector here is length==.ncol and</span></span>
<span>  <span class="co">##   we must replicate .nrow times each</span></span>
<span>  sample <span class="op">=</span> <span class="op">!</span><span class="op">!</span><span class="fu">quo_assay</span><span class="op">(</span><span class="fu">vctrs</span><span class="fu">::</span><span class="fu"><a href="https://vctrs.r-lib.org/reference/vec-rep.html" class="external-link">vec_rep_each</a></span><span class="op">(</span><span class="va">.cols</span><span class="op">$</span><span class="va">sample</span>, times <span class="op">=</span> <span class="va">.nrow</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  condition <span class="op">=</span> <span class="op">!</span><span class="op">!</span><span class="fu">quo_assay</span><span class="op">(</span><span class="fu">vctrs</span><span class="fu">::</span><span class="fu"><a href="https://vctrs.r-lib.org/reference/vec-rep.html" class="external-link">vec_rep_each</a></span><span class="op">(</span><span class="va">.cols</span><span class="op">$</span><span class="va">condition</span>, times <span class="op">=</span> <span class="va">.nrow</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Now each value is lazily available as it would be for a normal tibble. Note that the variables <code>.ncol</code> and <code>.nrow</code> are bound within <code>shared_env</code>, that <code>assay_mask_mid</code> is a child of.</p>
</div>
<div class="section level5">
<h5 id="rowdata-mask-moldings">rowData mask moldings<a class="anchor" aria-label="anchor" href="#rowdata-mask-moldings"></a>
</h5>
<p>I am still debating on the proper way to represent data within this context (and the colData context). For now I have settled on this expectation. Data represented here should be as if the user has unwrapped the <code>se</code> object and then nested by the rowData columns.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rowData_mask_mid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">new.env</a></span><span class="op">(</span>parent <span class="op">=</span> <span class="va">rowData_mask_top</span><span class="op">)</span></span>
<span><span class="va">quo_rowData</span> <span class="op">&lt;-</span> <span class="fu">quo_helper</span><span class="op">(</span><span class="va">rowData_mask_top</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rlang.r-lib.org/reference/env_bind.html" class="external-link">env_bind_lazy</a></span><span class="op">(</span></span>
<span>  <span class="va">rowData_mask_mid</span>,</span>
<span>  <span class="co">## Note, We do not need to make bindings</span></span>
<span>  <span class="co">## for rowData objects because they are </span></span>
<span>  <span class="co">## already in the desired form!</span></span>
<span>  </span>
<span>  <span class="co">## bindings for assays</span></span>
<span>  counts <span class="op">=</span> <span class="op">!</span><span class="op">!</span><span class="fu">quo_rowData</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">.nrow</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span>, <span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">[</span><span class="va">i</span>,,drop <span class="op">=</span> <span class="cn">TRUE</span><span class="op">]</span>, x <span class="op">=</span> <span class="va">.assay</span><span class="op">$</span><span class="va">counts</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  logcounts <span class="op">=</span> <span class="op">!</span><span class="op">!</span><span class="fu">quo_rowData</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">.nrow</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span>, <span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">[</span><span class="va">i</span>,,drop <span class="op">=</span> <span class="cn">TRUE</span><span class="op">]</span>, x <span class="op">=</span> <span class="va">.assay</span><span class="op">$</span><span class="va">logcounts</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="co">## bindings for colData</span></span>
<span>  sample <span class="op">=</span> <span class="op">!</span><span class="op">!</span><span class="fu">quo_rowData</span><span class="op">(</span><span class="fu">vctrs</span><span class="fu">::</span><span class="fu"><a href="https://vctrs.r-lib.org/reference/vec-rep.html" class="external-link">vec_rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">.cols</span><span class="op">$</span><span class="va">sample</span><span class="op">)</span>, times <span class="op">=</span> <span class="va">.nrow</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  condition <span class="op">=</span> <span class="op">!</span><span class="op">!</span><span class="fu">quo_rowData</span><span class="op">(</span><span class="fu">vctrs</span><span class="fu">::</span><span class="fu"><a href="https://vctrs.r-lib.org/reference/vec-rep.html" class="external-link">vec_rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">.cols</span><span class="op">$</span><span class="va">condition</span><span class="op">)</span>, times <span class="op">=</span> <span class="va">.nrow</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level5">
<h5 id="coldata-mask-moldings">colData mask moldings<a class="anchor" aria-label="anchor" href="#coldata-mask-moldings"></a>
</h5>
<p>Following the logic from the previous section, Data represeted here should be as if the user unwrapped the <code>se</code> object and then nested by the colData columns.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">colData_mask_mid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">new.env</a></span><span class="op">(</span>parent <span class="op">=</span> <span class="va">colData_mask_top</span><span class="op">)</span></span>
<span><span class="va">quo_colData</span> <span class="op">&lt;-</span> <span class="fu">quo_helper</span><span class="op">(</span><span class="va">colData_mask_top</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rlang.r-lib.org/reference/env_bind.html" class="external-link">env_bind_lazy</a></span><span class="op">(</span></span>
<span>  <span class="va">colData_mask_mid</span>,</span>
<span>  <span class="co">## No need to bind colData.</span></span>
<span>  </span>
<span>  <span class="co">## bindings for assays</span></span>
<span>  counts <span class="op">=</span> <span class="op">!</span><span class="op">!</span><span class="fu">quo_colData</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">.ncol</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span>, <span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">[</span>,<span class="va">i</span>,drop <span class="op">=</span> <span class="cn">TRUE</span><span class="op">]</span>, x <span class="op">=</span> <span class="va">.assay</span><span class="op">$</span><span class="va">counts</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  logcounts <span class="op">=</span> <span class="op">!</span><span class="op">!</span><span class="fu">quo_colData</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">.ncol</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span>, <span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">[</span>,<span class="va">i</span>,drop <span class="op">=</span> <span class="cn">TRUE</span><span class="op">]</span>, x <span class="op">=</span> <span class="va">.assay</span><span class="op">$</span><span class="va">logcounts</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="co">## binds for rowData</span></span>
<span>  gene <span class="op">=</span> <span class="op">!</span><span class="op">!</span><span class="fu">quo_colData</span><span class="op">(</span><span class="fu">vctrs</span><span class="fu">::</span><span class="fu"><a href="https://vctrs.r-lib.org/reference/vec-rep.html" class="external-link">vec_rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">.rows</span><span class="op">$</span><span class="va">gene</span><span class="op">)</span>, times <span class="op">=</span> <span class="va">.ncol</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  length <span class="op">=</span> <span class="op">!</span><span class="op">!</span><span class="fu">quo_colData</span><span class="op">(</span><span class="fu">vctrs</span><span class="fu">::</span><span class="fu"><a href="https://vctrs.r-lib.org/reference/vec-rep.html" class="external-link">vec_rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">.rows</span><span class="op">$</span><span class="va">length</span><span class="op">)</span>, times <span class="op">=</span> <span class="va">.ncol</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  direction <span class="op">=</span> <span class="op">!</span><span class="op">!</span><span class="fu">quo_colData</span><span class="op">(</span><span class="fu">vctrs</span><span class="fu">::</span><span class="fu"><a href="https://vctrs.r-lib.org/reference/vec-rep.html" class="external-link">vec_rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">.rows</span><span class="op">$</span><span class="va">direction</span><span class="op">)</span>, times <span class="op">=</span> <span class="va">.ncol</span><span class="op">)</span><span class="op">)</span>,</span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level4">
<h4 id="bottom-level-of-the-mask">Bottom level of the mask<a class="anchor" aria-label="anchor" href="#bottom-level-of-the-mask"></a>
</h4>
<p>I am still debating if this portion of the mask is required. In the current construction, we bind these values to active Binding functions, that simply force the evaluation of the lazily bound expressions defined earlier.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># helper function</span></span>
<span><span class="va">force_fn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">name</span>, <span class="va">env</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rlang.r-lib.org/reference/new_function.html" class="external-link">new_function</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">pairlist</a></span><span class="op">(</span><span class="op">)</span>, body <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/name.html" class="external-link">as.name</a></span><span class="op">(</span><span class="va">name</span><span class="op">)</span>, env <span class="op">=</span> <span class="va">env</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">bind_names</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">names</span>, <span class="va">env</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span>nm <span class="op">=</span> <span class="va">names</span><span class="op">)</span>,</span>
<span>         <span class="va">force_fn</span>, env <span class="op">=</span> <span class="va">env</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">all_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"counts"</span>, <span class="st">"logcounts"</span>,</span>
<span>               <span class="st">"gene"</span>, <span class="st">"length"</span>, <span class="st">"direction"</span>,</span>
<span>               <span class="st">"sample"</span>, <span class="st">"condition"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">assay_mask_bot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">new.env</a></span><span class="op">(</span>parent <span class="op">=</span> <span class="va">assay_mask_mid</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rlang.r-lib.org/reference/env_bind.html" class="external-link">env_bind_active</a></span><span class="op">(</span></span>
<span>  <span class="va">assay_mask_bot</span>,</span>
<span>  <span class="op">!</span><span class="op">!</span><span class="op">!</span> <span class="fu">bind_names</span><span class="op">(</span><span class="va">all_names</span>, <span class="va">assay_mask_mid</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">rowData_mask_bot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">new.env</a></span><span class="op">(</span>parent <span class="op">=</span> <span class="va">rowData_mask_mid</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rlang.r-lib.org/reference/env_bind.html" class="external-link">env_bind_active</a></span><span class="op">(</span></span>
<span>  <span class="va">rowData_mask_bot</span>,</span>
<span>  <span class="op">!</span><span class="op">!</span><span class="op">!</span> <span class="fu">bind_names</span><span class="op">(</span><span class="va">all_names</span>, <span class="va">rowData_mask_mid</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">colData_mask_bot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">new.env</a></span><span class="op">(</span>parent <span class="op">=</span><span class="va">colData_mask_mid</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rlang.r-lib.org/reference/env_bind.html" class="external-link">env_bind_active</a></span><span class="op">(</span></span>
<span>  <span class="va">colData_mask_bot</span>,</span>
<span>  <span class="op">!</span><span class="op">!</span><span class="op">!</span> <span class="fu">bind_names</span><span class="op">(</span><span class="va">all_names</span>,<span class="va">colData_mask_mid</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="creating-rlang-data-masks">Creating <code>rlang</code> data masks<a class="anchor" aria-label="anchor" href="#creating-rlang-data-masks"></a>
</h4>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#test expression</span></span>
<span><span class="va">my_tibble_expr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/expr.html" class="external-link">expr</a></span><span class="op">(</span></span>
<span>  <span class="fu">tibble</span><span class="op">(</span></span>
<span>    counts <span class="op">=</span> <span class="va">counts</span>,</span>
<span>    length <span class="op">=</span> <span class="va">length</span>,</span>
<span>    condition <span class="op">=</span> <span class="va">condition</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="section level5">
<h5 id="assay-mask">assay mask<a class="anchor" aria-label="anchor" href="#assay-mask"></a>
</h5>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">assay_mask</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/as_data_mask.html" class="external-link">new_data_mask</a></span><span class="op">(</span><span class="va">assay_mask_bot</span>, top <span class="op">=</span> <span class="va">shared_env</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rlang.r-lib.org/reference/eval_tidy.html" class="external-link">eval_tidy</a></span><span class="op">(</span><span class="va">my_tibble_expr</span>, <span class="va">assay_mask</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="co"># A tibble: 20 × 3</span></span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>   counts length condition</span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a>    <span class="sc">&lt;</span>int<span class="sc">&gt;</span>  <span class="er">&lt;</span>int<span class="sc">&gt;</span> <span class="er">&lt;</span>chr<span class="sc">&gt;</span>    </span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a> <span class="dv">1</span>     <span class="dv">16</span>      <span class="dv">3</span> cntrl    </span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a> <span class="dv">2</span>      <span class="dv">5</span>     <span class="dv">51</span> cntrl    </span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a> <span class="dv">3</span>     <span class="dv">12</span>     <span class="dv">24</span> cntrl    </span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a> <span class="dv">4</span>     <span class="dv">15</span>     <span class="dv">32</span> cntrl    </span>
<span id="cb19-8"><a href="#cb19-8" tabindex="-1"></a> <span class="dv">5</span>      <span class="dv">9</span>     <span class="dv">49</span> cntrl    </span>
<span id="cb19-9"><a href="#cb19-9" tabindex="-1"></a> <span class="dv">6</span>     <span class="dv">19</span>      <span class="dv">3</span> cntrl    </span>
<span id="cb19-10"><a href="#cb19-10" tabindex="-1"></a> <span class="dv">7</span>      <span class="dv">6</span>     <span class="dv">51</span> cntrl    </span>
<span id="cb19-11"><a href="#cb19-11" tabindex="-1"></a> <span class="dv">8</span>      <span class="dv">4</span>     <span class="dv">24</span> cntrl    </span>
<span id="cb19-12"><a href="#cb19-12" tabindex="-1"></a> <span class="dv">9</span>      <span class="dv">2</span>     <span class="dv">32</span> cntrl    </span>
<span id="cb19-13"><a href="#cb19-13" tabindex="-1"></a><span class="dv">10</span>      <span class="dv">7</span>     <span class="dv">49</span> cntrl    </span>
<span id="cb19-14"><a href="#cb19-14" tabindex="-1"></a><span class="dv">11</span>     <span class="dv">14</span>      <span class="dv">3</span> drug     </span>
<span id="cb19-15"><a href="#cb19-15" tabindex="-1"></a><span class="dv">12</span>     <span class="dv">10</span>     <span class="dv">51</span> drug     </span>
<span id="cb19-16"><a href="#cb19-16" tabindex="-1"></a><span class="dv">13</span>     <span class="dv">11</span>     <span class="dv">24</span> drug     </span>
<span id="cb19-17"><a href="#cb19-17" tabindex="-1"></a><span class="dv">14</span>     <span class="dv">20</span>     <span class="dv">32</span> drug     </span>
<span id="cb19-18"><a href="#cb19-18" tabindex="-1"></a><span class="dv">15</span>     <span class="dv">13</span>     <span class="dv">49</span> drug     </span>
<span id="cb19-19"><a href="#cb19-19" tabindex="-1"></a><span class="dv">16</span>      <span class="dv">8</span>      <span class="dv">3</span> drug     </span>
<span id="cb19-20"><a href="#cb19-20" tabindex="-1"></a><span class="dv">17</span>     <span class="dv">17</span>     <span class="dv">51</span> drug     </span>
<span id="cb19-21"><a href="#cb19-21" tabindex="-1"></a><span class="dv">18</span>      <span class="dv">1</span>     <span class="dv">24</span> drug     </span>
<span id="cb19-22"><a href="#cb19-22" tabindex="-1"></a><span class="dv">19</span>     <span class="dv">18</span>     <span class="dv">32</span> drug     </span>
<span id="cb19-23"><a href="#cb19-23" tabindex="-1"></a><span class="dv">20</span>      <span class="dv">3</span>     <span class="dv">49</span> drug     </span></code></pre></div>
</div>
<div class="section level5">
<h5 id="rowdata-mask">rowData mask<a class="anchor" aria-label="anchor" href="#rowdata-mask"></a>
</h5>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rowData_mask</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/as_data_mask.html" class="external-link">new_data_mask</a></span><span class="op">(</span><span class="va">rowData_mask_bot</span>, top <span class="op">=</span> <span class="va">shared_env</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rlang.r-lib.org/reference/eval_tidy.html" class="external-link">eval_tidy</a></span><span class="op">(</span><span class="va">my_tibble_expr</span>, <span class="va">rowData_mask</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="co"># A tibble: 5 × 3</span></span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a>  counts    length condition</span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a>  <span class="sc">&lt;</span>list<span class="sc">&gt;</span>     <span class="er">&lt;</span>int<span class="sc">&gt;</span> <span class="er">&lt;</span>list<span class="sc">&gt;</span>   </span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a><span class="dv">1</span> <span class="sc">&lt;</span>int [<span class="dv">4</span>]<span class="sc">&gt;</span>      <span class="dv">3</span> <span class="sc">&lt;</span>chr [<span class="dv">4</span>]<span class="sc">&gt;</span></span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a><span class="dv">2</span> <span class="sc">&lt;</span>int [<span class="dv">4</span>]<span class="sc">&gt;</span>     <span class="dv">51</span> <span class="sc">&lt;</span>chr [<span class="dv">4</span>]<span class="sc">&gt;</span></span>
<span id="cb21-6"><a href="#cb21-6" tabindex="-1"></a><span class="dv">3</span> <span class="sc">&lt;</span>int [<span class="dv">4</span>]<span class="sc">&gt;</span>     <span class="dv">24</span> <span class="sc">&lt;</span>chr [<span class="dv">4</span>]<span class="sc">&gt;</span></span>
<span id="cb21-7"><a href="#cb21-7" tabindex="-1"></a><span class="dv">4</span> <span class="sc">&lt;</span>int [<span class="dv">4</span>]<span class="sc">&gt;</span>     <span class="dv">32</span> <span class="sc">&lt;</span>chr [<span class="dv">4</span>]<span class="sc">&gt;</span></span>
<span id="cb21-8"><a href="#cb21-8" tabindex="-1"></a><span class="dv">5</span> <span class="sc">&lt;</span>int [<span class="dv">4</span>]<span class="sc">&gt;</span>     <span class="dv">49</span> <span class="sc">&lt;</span>chr [<span class="dv">4</span>]<span class="sc">&gt;</span></span></code></pre></div>
</div>
<div class="section level5">
<h5 id="coldata-mask">colData mask<a class="anchor" aria-label="anchor" href="#coldata-mask"></a>
</h5>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">colData_mask</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/as_data_mask.html" class="external-link">new_data_mask</a></span><span class="op">(</span><span class="va">colData_mask_bot</span>, top <span class="op">=</span> <span class="va">shared_env</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rlang.r-lib.org/reference/eval_tidy.html" class="external-link">eval_tidy</a></span><span class="op">(</span><span class="va">my_tibble_expr</span>, <span class="va">colData_mask</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="co"># A tibble: 4 × 3</span></span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a>  counts    length    condition</span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a>  <span class="sc">&lt;</span>list<span class="sc">&gt;</span>    <span class="er">&lt;</span>list<span class="sc">&gt;</span>    <span class="er">&lt;</span>chr<span class="sc">&gt;</span>    </span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a><span class="dv">1</span> <span class="sc">&lt;</span>int [<span class="dv">5</span>]<span class="sc">&gt;</span> <span class="er">&lt;</span>int [<span class="dv">5</span>]<span class="sc">&gt;</span> cntrl    </span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a><span class="dv">2</span> <span class="sc">&lt;</span>int [<span class="dv">5</span>]<span class="sc">&gt;</span> <span class="er">&lt;</span>int [<span class="dv">5</span>]<span class="sc">&gt;</span> cntrl    </span>
<span id="cb23-6"><a href="#cb23-6" tabindex="-1"></a><span class="dv">3</span> <span class="sc">&lt;</span>int [<span class="dv">5</span>]<span class="sc">&gt;</span> <span class="er">&lt;</span>int [<span class="dv">5</span>]<span class="sc">&gt;</span> drug     </span>
<span id="cb23-7"><a href="#cb23-7" tabindex="-1"></a><span class="dv">4</span> <span class="sc">&lt;</span>int [<span class="dv">5</span>]<span class="sc">&gt;</span> <span class="er">&lt;</span>int [<span class="dv">5</span>]<span class="sc">&gt;</span> drug     </span></code></pre></div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="wrapping-it-all-up">Wrapping it all up<a class="anchor" aria-label="anchor" href="#wrapping-it-all-up"></a>
</h3>
<p>Everything under the proposal is to demonstrate how these masks may work. With the data pronouns we may access the “unmolded” data regardless of the context, and the molded data give us our desired vector outputs. Lazily binding these expressions means that expensive operations are not evaluated unless forced by the user.</p>
<p>The proposal is fairly verbose, but we can do all of the above programatically. The plan currently is to have R6 classes handle the binding of the data. One R6 object will handle the hierarchy of environments for each mask, dubbed as the <code>DataMaskAbstraction</code>, and another R6 object, dubbed as the <code>DataMaskSEManager</code>, will handle these abstractions and provide methods to evaluate in the desired contexts. This approach is similar to how <code>dplyr</code> has gone about structuring their data masks, wrapping it in their own R6 class (see <code>dplyr:::DataMask</code>).</p>
</div>
<div class="section level3">
<h3 id="contextual-helpers">contextual helpers<a class="anchor" aria-label="anchor" href="#contextual-helpers"></a>
</h3>
<p>To make this feel more natural, we can optionally include contextual helper functions. I propose that the defaul mask everything may be evaluated in is the <code>assay_mask</code>. We can provide “helper” functions (similar to <code><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">dplyr::across</a></code>) that modifies the behavior of the dplyr verb within its context.</p>
<p>We can provide two functions <code>rows(...)</code> and <code>cols(...)</code> (names TBD) that will evaluate the named expressions of <code>...</code> in <code>rowData_mask</code> and <code>colData_mask</code> respectively. Results for these masks will also expect output lengths of <code>.nrow</code> and <code>.ncol</code> respectively and will be assigned back to the respective mask’s top level environment (lazy re-bindings across the other masks will be handled by the <code>DataMaskSEManager</code> if appropriate).</p>
<p>We can copy <code>dplyr</code>’s approach with caching contextual information by using an internal environment (<code>dplyr:::context_peek</code>, <code>dplyr:::context_poke</code>).</p>
<p>The downside of this proposal is that we will need to make our own methods for the helper functions that dplyr provides. Examples would be <code><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">cur_group_id()</a></code>, etc (see <code><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">?dplyr::context</a></code>)</p>
</div>
</div>
<div class="section level2">
<h2 id="dplyr-verbs">
<code>dplyr</code> verbs<a class="anchor" aria-label="anchor" href="#dplyr-verbs"></a>
</h2>
<p>This section is to discuss how the various dplyr verbs would work under these abstractions</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="va">tibble_expr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/expr.html" class="external-link">expr</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>      counts <span class="op">=</span> <span class="va">counts</span>,</span>
<span>      logcounts <span class="op">=</span> <span class="va">logcounts</span>,</span>
<span>      gene <span class="op">=</span> <span class="va">gene</span>,</span>
<span>      length <span class="op">=</span> <span class="va">length</span>,</span>
<span>      direction <span class="op">=</span> <span class="va">direction</span>,</span>
<span>      sample <span class="op">=</span> <span class="va">sample</span>,</span>
<span>      condition <span class="op">=</span> <span class="va">condition</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">assay_ctx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/eval_tidy.html" class="external-link">eval_tidy</a></span><span class="op">(</span><span class="va">tibble_expr</span>, <span class="va">assay_mask</span><span class="op">)</span></span>
<span><span class="va">rowData_ctx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/eval_tidy.html" class="external-link">eval_tidy</a></span><span class="op">(</span><span class="va">tibble_expr</span>, <span class="va">rowData_mask</span><span class="op">)</span></span>
<span><span class="va">colData_ctx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/eval_tidy.html" class="external-link">eval_tidy</a></span><span class="op">(</span><span class="va">tibble_expr</span>, <span class="va">colData_mask</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="mutate">
<code>mutate</code><a class="anchor" aria-label="anchor" href="#mutate"></a>
</h3>
<p><code>mutate</code> is one of the more common <code>dplyr</code> verbs used and is likely the most compatible.</p>
</div>
<div class="section level3">
<h3 id="filter">
<code>filter</code><a class="anchor" aria-label="anchor" href="#filter"></a>
</h3>
<p><code>filter</code> is easy in theory to implement, but certain filters of a tidy dataset cannot recover a valid <code>SummarizedExperiment</code> object.</p>
<p>For example, consider this <code>mutate.data.frame</code> call:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">assay_ctx</span>, <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb26"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a><span class="co"># A tibble: 2 × 7</span></span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a>  counts logcounts gene  length direction sample condition</span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a>   <span class="sc">&lt;</span>int<span class="sc">&gt;</span>     <span class="er">&lt;</span>dbl<span class="sc">&gt;</span> <span class="er">&lt;</span>chr<span class="sc">&gt;</span>  <span class="er">&lt;</span>int<span class="sc">&gt;</span> <span class="er">&lt;</span>chr<span class="sc">&gt;</span>     <span class="er">&lt;</span>chr<span class="sc">&gt;</span>  <span class="er">&lt;</span>chr<span class="sc">&gt;</span>    </span>
<span id="cb26-4"><a href="#cb26-4" tabindex="-1"></a><span class="dv">1</span>     <span class="dv">16</span>      <span class="fl">2.77</span> g1         <span class="dv">3</span> <span class="sc">-</span>         s1     cntrl    </span>
<span id="cb26-5"><a href="#cb26-5" tabindex="-1"></a><span class="dv">2</span>      <span class="dv">3</span>      <span class="fl">1.10</span> g5        <span class="dv">49</span> <span class="sc">+</span>         s4     drug     </span></code></pre></div>
<p>the closest equivalent for <code>se</code> would be:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">se</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<div class="sourceCode" id="cb28"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a><span class="co"># A SummarizedExperiment-tibble Abstraction: 2 × 2</span></span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a>  .features .samples <span class="sc">|</span> counts logcounts <span class="sc">|</span> gene  length direction <span class="sc">|</span> sample</span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a>  <span class="sc">&lt;</span>chr<span class="sc">&gt;</span>     <span class="er">&lt;</span>chr<span class="sc">&gt;</span>    <span class="er">|</span>  <span class="er">&lt;</span>int<span class="sc">&gt;</span>     <span class="er">&lt;</span>dbl<span class="sc">&gt;</span> <span class="er">|</span> <span class="er">&lt;</span>chr<span class="sc">&gt;</span>  <span class="er">&lt;</span>int<span class="sc">&gt;</span> <span class="er">&lt;</span>chr<span class="sc">&gt;</span>     <span class="er">|</span> <span class="er">&lt;</span>chr<span class="sc">&gt;</span> </span>
<span id="cb28-4"><a href="#cb28-4" tabindex="-1"></a><span class="dv">1</span> row_a     col_A    <span class="sc">|</span>     <span class="dv">16</span>      <span class="fl">2.77</span> <span class="sc">|</span> g1         <span class="dv">3</span> <span class="sc">-</span>         <span class="er">|</span> s1    </span>
<span id="cb28-5"><a href="#cb28-5" tabindex="-1"></a><span class="dv">2</span> row_e     col_A    <span class="sc">|</span>      <span class="dv">9</span>      <span class="fl">2.20</span> <span class="sc">|</span> g5        <span class="dv">49</span> <span class="sc">+</span>         <span class="er">|</span> s1    </span>
<span id="cb28-6"><a href="#cb28-6" tabindex="-1"></a><span class="dv">3</span> row_a     col_D    <span class="sc">|</span>      <span class="dv">8</span>      <span class="fl">2.08</span> <span class="sc">|</span> g1         <span class="dv">3</span> <span class="sc">-</span>         <span class="er">|</span> s4    </span>
<span id="cb28-7"><a href="#cb28-7" tabindex="-1"></a><span class="dv">4</span> row_e     col_D    <span class="sc">|</span>      <span class="dv">3</span>      <span class="fl">1.10</span> <span class="sc">|</span> g5        <span class="dv">49</span> <span class="sc">+</span>         <span class="er">|</span> s4    </span>
<span id="cb28-8"><a href="#cb28-8" tabindex="-1"></a><span class="co"># ℹ 1 more variable: condition &lt;chr&gt;</span></span></code></pre></div>
<p>Thus I think it would make sense to error if the user attempts to filter in the assay context and inform them that a valid <code>SummarizedExperiment</code> object cannot be returned. To perform such filters, the user should convert to a tibble explicitly first.</p>
</div>
<div class="section level3">
<h3 id="group_by">
<code>group_by</code><a class="anchor" aria-label="anchor" href="#group_by"></a>
</h3>
<p>This will likely be more difficult to implement. I will need to look more into how <code>dplyr</code> manages this. Most fo the methods in <code>dplyr::DataMask</code> are external calls to cpp code, but it seems that they cache the “chops” and possibly make a mask per data chop.</p>
</div>
<div class="section level3">
<h3 id="summarizesummarise">
<code>summarize/summarise</code><a class="anchor" aria-label="anchor" href="#summarizesummarise"></a>
</h3>
<p>I personally think the use case for these would be extremely limited. The <code>summarize</code> functions have the side effect of only retaining the grouped variables as well as newly evaluated expressions. We <strong>could</strong> make this functionality, but I wonder how often it would be useful. It is usually more useful to store summaries of each row or column in <code>rowData</code> and <code>colData</code> respectively, which is already doable through <code>mutate</code>.</p>
<p>I suppose that there would be a world in which a user may use <code>summarize</code> to make a model for each group, but the output would not fit the <code>SummarizedExperiment</code> framework (i think) and should probably return a tibble.</p>
</div>
<div class="section level3">
<h3 id="distinct">
<code>distinct</code><a class="anchor" aria-label="anchor" href="#distinct"></a>
</h3>
<p>Probably should not implement this method for similar reasons to <code>filter</code>. If it is implemented, it cannot return a <code>SummarizedExperiment</code> object.</p>
</div>
</div>
</div>
  </main><aside class="col-md-3"><div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/jtlandis/biocmask/" class="external-link">Browse source code</a></li>
<li><a href="https://www.github.com/jtlandis/biocmask/issues" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php" class="external-link">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing biocmask</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>
<a href="https://github.com/jtlandis" class="external-link">Justin Landis</a> <br><small class="roles"> Author, maintainer </small> <a href="https://orcid.org/0000-0001-5501-4934" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
<li>
<a href="https://mikelove.github.io" class="external-link">Michael Love</a> <br><small class="roles"> Author </small> <a href="https://orcid.org/0000-0001-8401-0545" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
</ul>
</div>



  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/jtlandis" class="external-link">Justin Landis</a>, <a href="https://mikelove.github.io" class="external-link">Michael Love</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
